#/lib/systemd/system
[Unit]
Description="TeamCity Agent"
{% if waitvpn is defined %}
Wants=sys-devices-virtual-net-tap.device
After=sys-devices-virtual-net-tap.device
{% endif %}

[Service]
User={{ teamcity_agent_user }}
ExecStart=/bin/bash -c '\
    source /etc/default/teamcity-agent;\
    while [ -z $(nslookup teamcity.office.fusioncore.ru | grep 10.10) ]; do echo "not yet right dns"; sleep 1; done; \
    exec {{ teamcity_agent_install_dir }}/bin/agent.sh run'
ExecStop={{ teamcity_agent_install_dir }}/bin/agent.sh stop
RemainAfterExit=yes
ExecStartPost=/bin/bash -c 'while ! tail -5 {{ teamcity_agent_install_dir }}/logs/teamcity-agent.log | grep "Updating agent parameters on the server"; do sleep 1 ; done; exec /usr/bin/curl -sS -X PUT --data "true" -H "Content-Type:text/plain" -u {{ teamcity_server_user_name }}:{{ teamcity_server_user_passwd }} https://{{ teamcity_agent_server_url }}/app/rest/agents/{{ teamcity_agent_hostname }}/authorized'
TimeoutSec=600

[Install]
WantedBy=multi-user.target
